# Replication Controller to create and maintain Keeper pods.
#
# See http://kubernetes.io/docs/user-guide/replication-controller/
#
# Note that we can't use this yet since the Keeper application relies upon
# an sqlite database held in persistent storage. Deploy a lone pod instead
# with keeper-pod.yaml

apiVersion: v1
kind: ReplicationController
metadata:
  name: keeper
  labels:
    name: keeper
spec:
  replicas: 1
  selector:
    name: keeper

  template:

  # Template for a pod containing the nginx and uwsgi (Keeper) containers
  # see http://kubernetes.io/docs/user-guide/pods/

    metadata:
      name: keeper
      labels:
        name: keeper
    spec:
      containers:

        - name: nginx
          image: lsstsqre/nginx-python:k8s
          ports:
            - containerPort: 80

        - name: uwsgi
          image: lsstsqre/ltd-keeper:latest
          ports:
            - containerPort: 3031
              name: keeper
          env:
            - name: LTD_KEEPER_PROFILE
              value: production
            - name: LTD_KEEPER_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: secret-key
            - name: LTD_KEEPER_AWS_ID
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: aws-id
            - name: LTD_KEEPER_AWS_SECRET
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: aws-secret
            - name: LTD_KEEPER_BOOTSTRAP_USER
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: default-user
            - name: LTD_KEEPER_BOOTSTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: default-user
            - name: LTD_KEEPER_URL
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: server-name
            - name: LTD_KEEPER_URL_SCHEME
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: preferred-url-scheme
            - name: LTD_KEEPER_DB_URL
              valueFrom:
                secretKeyRef:
                  name: keeper-secrets
                  key: db-url
